<!DOCTYPE html>
<html>
  <head>
    <title>REPL</title>
    <style>
    body {
      font-family: sans-serif;
      margin: 0 auto;
      width: 600px;
    }
    #prompt {
      color: blue;
      border-top: 1px solid #CCC;
    }
    #prompt_line {
      color: black;
      display: block;
    }
    #gt {
      float: left;
    }
    </style>
  </head>
  <body>
    <h1>Node Web REPL</h1>
    <p>
      <a href="#" id="close">Close Connection.</a> | <a href="#" id="open">Open Connection.</a>
    </p>
    <pre><div id="log"></div><div id="prompt"><span id="gt">&gt; </span><span id="prompt_line" contenteditable><br/></span></div></pre>
    <a href="http://nodeknockout.com/teams/nv"><img style="position: fixed; top: 5px; right: 5px; border: 0;" src="http://nodeknockout.com/images/voteko.png" alt="Help me win Node.js KO!" /></a>
<script type="text/javascript">
// FIXME: move it to utils.js
Array.prototype.__defineGetter__("last", function(){
  return this[this.length - 1];
});

/**
 * @param {Number} [start=0] >= 0
 * @param {Number} [end=start] >= 0
 * @see http://github.com/NV/select-text.js
 */
Element.prototype.select = function select(start, end) {
  start = start || 0;

  if (arguments.length < 2)
    end = start;
  else
    end = Math.min(end, this.textContent.length);

  var range = document.createRange();
  var node = this.firstChild;

  if (node) {

    var i = start;
    var length;

    while (i > (length = node.textContent.length)) {
      i -= length;
      node = node.nextSibling;
    }

    var startNode;
    if (node.firstChild) {
      startNode = node.firstChild;
      while (startNode.firstChild)
        startNode = startNode.firstChild;

    } else
      startNode = node;

    range.setStart(startNode, i);

    var j = end - (start - i);
    while (j > (length = node.textContent.length)) {
      j -= length;
      node = node.nextSibling;
    }

    var endNode;
    if (node.firstChild) {
      endNode = node.firstChild;
      while (endNode.firstChild)
        endNode = endNode.firstChild;

    } else
      endNode = node;

    range.setEnd(endNode, j);

  } else {
    range.setStartBefore(this);
    range.setEndBefore(this);
  }

  var selection = getSelection();
  selection.removeAllRanges();
  selection.addRange(range);

  return this;
};


var prompt = document.getElementById("prompt");
var prompt_line = document.getElementById("prompt_line");
var output_log = document.getElementById("log");


function scrollToBottom() {
  window.scrollBy(0, document.body.scrollHeight - document.body.scrollTop);
}

function log(data){
  if (data != ">") {
    output_log.innerHTML += data;
  }
}


var conn;
var connect = function() {
  if (window.WebSocket) {
    conn = new WebSocket("ws://"+ location.host +"/test");

    conn.onmessage = function(event) {
      log(event.data);
    };

    conn.onclose = function() {
      log("closed");
    };

    conn.onopen = function() {
      log("opened");
    };
  }
};



document.getElementById("close").addEventListener("click", function(e) {
  if (conn) {
    conn.close();
    conn = false;
  }
  e.preventDefault();
  return false;
}, false);

document.getElementById("open").addEventListener("click", function(e) {
  if (!conn) {
    connect();
  }
  e.preventDefault();
  return false;
}, false);


function execute() {
  var code = prompt_line.textContent;
  output_log.innerHTML += prompt.textContent + "\n";
  conn.send(code);
  prompt_line.innerHTML = " <br>";
  prompt_line.select();
}


prompt_line.addEventListener("keypress", function(event) {
  if (event.which === 13) { // Enter key
    execute();
    event.preventDefault();
  }
}, false);

document.documentElement.addEventListener("click", function(event) {
  if (event.target.id == "prompt_line" || event.target.parentNode.id == "prompt_line") {
    return;
  }
  selectEnd();
}, true);


function selectEnd(){
  var l = prompt_line.textContent.length;
  prompt_line.select(l);
}


window.onload = function(){
  connect();
  selectEnd()
};
</script></body></html>